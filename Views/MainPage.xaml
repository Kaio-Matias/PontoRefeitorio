<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:PontoRefeitorio.ViewModels"
             xmlns:camera="clr-namespace:CommunityToolkit.Maui.Views;assembly=CommunityToolkit.Maui.Camera"
             xmlns:media="clr-namespace:CommunityToolkit.Maui.Views;assembly=CommunityToolkit.Maui.MediaElement"
             x:DataType="viewmodel:MainPageViewModel"
             x:Class="PontoRefeitorio.Views.MainPage"
             Shell.NavBarIsVisible="False"
             BackgroundColor="White">

    <Grid>
        <!-- Estrutura Principal: Conteúdo Centralizado e Rodapé -->
        <Grid RowDefinitions="*, Auto">

            <!-- 1. MOLDURA LARANJA (Câmera Limitada aqui dentro) -->
            <!-- IsClippedToBounds removido: O StrokeShape já cuida do corte -->
            <Border Grid.Row="0"
                    Stroke="#DE7913"
                    StrokeThickness="4"
                    StrokeShape="RoundRectangle 30"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    HeightRequest="450"
                    WidthRequest="350"
                    BackgroundColor="#F0F0F0">

                <Grid>
                    <!-- CÂMERA: Agora confinada dentro da borda -->
                    <camera:CameraView x:Name="cameraView" 
                                       HorizontalOptions="FillAndExpand" 
                                       VerticalOptions="FillAndExpand"/>

                    <!-- PREVIEW: Foto estática (aparece sobre a câmera ao capturar) -->
                    <Image Source="{Binding PreviewImageSource}" 
                           Aspect="AspectFill"
                           IsVisible="{Binding ShowPreview}"
                           HorizontalOptions="FillAndExpand"
                           VerticalOptions="FillAndExpand"/>

                    <!-- CONTAGEM REGRESSIVA (Centralizada na moldura) -->
                    <Label Text="{Binding CountdownText}"
                           IsVisible="{Binding ShowCountdown}"
                           FontSize="120" 
                           FontAttributes="Bold" 
                           TextColor="White"
                           HorizontalOptions="Center" 
                           VerticalOptions="Center">
                        <Label.Shadow>
                            <Shadow Brush="Black" Offset="3,3" Radius="10" />
                        </Label.Shadow>
                    </Label>
                </Grid>
            </Border>

            <!-- 2. ÁREA DE BOTÕES (Aparece abaixo da moldura) -->
            <VerticalStackLayout Grid.Row="1" 
                                 Spacing="15" 
                                 Padding="20, 10, 20, 40" 
                                 IsVisible="{Binding ShowPreview}">

                <Label Text="Confirma o registro?" 
                       TextColor="Black" 
                       FontSize="22" 
                       HorizontalOptions="Center" 
                       FontAttributes="Bold"/>

                <!-- CORREÇÃO: Spacing trocado por ColumnSpacing -->
                <Grid ColumnDefinitions="Auto, *" ColumnSpacing="15">
                    <!-- Botão Cancelar (X) -->
                    <Button Grid.Column="0"
                            Text="X"
                            Command="{Binding CancelAndGoBackCommand}"
                            BackgroundColor="#D32F2F"
                            TextColor="White"
                            FontAttributes="Bold"
                            FontSize="24"
                            WidthRequest="70"
                            HeightRequest="70"
                            CornerRadius="35"/>

                    <!-- Botão Confirmar (Grande) -->
                    <Button Grid.Column="1"
                            Text="{Binding ConfirmationButtonText}"
                            Command="{Binding ConfirmAndSendCommand}"
                            BackgroundColor="#388E3C"
                            TextColor="White"
                            FontSize="20"
                            FontAttributes="Bold"
                            HeightRequest="70"
                            CornerRadius="35"
                            HorizontalOptions="FillAndExpand"/>
                </Grid>
            </VerticalStackLayout>
        </Grid>

        <!-- 3. POPUP DE RESULTADO (Overlay em tela cheia para feedback) -->
        <Grid IsVisible="{Binding ShowResultPopup}" BackgroundColor="#CC000000">
            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="20">

                <Label Text="{Binding ColaboradorNome}"
                       FontSize="24" TextColor="White" HorizontalTextAlignment="Center"/>

                <!-- Moldura menor para mostrar a foto processada no resultado -->
                <Border StrokeShape="RoundRectangle 20" HeightRequest="300" WidthRequest="225" BackgroundColor="{Binding ResultBackgroundColor}">
                    <Image Source="{Binding ResultImageSource}" Aspect="AspectFill" />
                </Border>

                <Label Text="{Binding ResultMessage}"
                       FontSize="28" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>

                <ActivityIndicator IsRunning="{Binding IsBusy}" Color="White" IsVisible="{Binding IsBusy}"/>
            </VerticalStackLayout>
        </Grid>

        <!-- Elemento de mídia oculto (para sons, se necessário) -->
        <media:MediaElement x:Name="mediaElement" IsVisible="False" />
    </Grid>
</ContentPage>